<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>üíé 3D NFT Universe - Combat</title>

<!-- Supabase & Web3.js & WalletConnect -->
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<script src="https://cdn.jsdelivr.net/npm/web3/dist/web3.min.js"></script>
<script src="https://unpkg.com/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>

<!-- Three.js for 3D rendering -->
<script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/PointerLockControls.js"></script>

<style>
  :root {
    --bg: #f8fafc;
    --card-bg: #ffffff;
    --text-dark: #1e293b;
    --text-light: #475569;
    --accent: #3b82f6;
    --shadow: 0 4px 12px rgba(0,0,0,0.08);
    --sidebar-width: 250px;
    --sidebar-collapsed: 50px;
  }
  
  .homepage{
    border-style: outset;
    width: 120px;
    height: 45px;
    background-image: url('https://i.pinimg.com/564x/35/38/ed/3538edbdb531c7fe3bb387ead4b398b0.jpg');
    background-size: 120px 45px;
    border-radius: 50%;
    text-align: center;
    line-height: 45px;
    color: white;
    font-weight: bold;
    position: absolute;
    top: 10px;
    left: 10px;
    z-index: 100;
    font-size: 0.8rem;
  }
  
  * { box-sizing: border-box; }
  body { 
    font-family: system-ui, sans-serif; 
    background: var(--bg); 
    margin: 0; 
    padding: 0; 
    color: var(--text-dark); 
    overflow: hidden;
    touch-action: none;
  }
  
  header { 
    background: var(--card-bg); 
    text-align: center; 
    padding: 12px 8px; 
    border-bottom: 1px solid #e2e8f0; 
    position: absolute; 
    top: 0; 
    width: 100%; 
    z-index: 10; 
  }
  
  h1 { font-size: 1.4rem; margin: 0; }
  #walletStatus { margin-top: 6px; font-size: 0.8rem; color: var(--text-light); }
  #connectBtn { 
    margin-top: 4px; 
    padding: 4px 8px;
    font-size: 0.8rem;
  }
  
  #canvas-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
  }
  
  #instructions {
    position: absolute;
    bottom: 10px;
    left: 0;
    width: 100%;
    text-align: center;
    color: white;
    background-color: rgba(0,0,0,0.7);
    padding: 8px;
    z-index: 100;
    font-size: 0.8rem;
  }
  
  #mobile-controls {
    position: absolute;
    bottom: 80px;
    right: 10px;
    z-index: 100;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  
  .mobile-btn {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: rgba(59, 130, 246, 0.7);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    font-weight: bold;
    user-select: none;
    -webkit-user-select: none;
    touch-action: manipulation;
  }
  
  #gun-btn {
    background: rgba(220, 38, 38, 0.7);
    font-size: 1.5rem;
  }
  
  #look-controls {
    position: absolute;
    bottom: 80px;
    left: 10px;
    width: 120px;
    height: 120px;
    z-index: 100;
    background: rgba(0,0,0,0.2);
    border-radius: 50%;
    touch-action: none;
  }
  
  #nft-modal {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: var(--card-bg);
    border-radius: 16px;
    box-shadow: var(--shadow);
    padding: 20px;
    z-index: 1000;
    max-width: 90%;
    width: 350px;
    max-height: 80vh;
    overflow-y: auto;
  }
  
  #nft-modal img {
    width: 100%;
    height: 200px;
    object-fit: cover;
    display: block;
    border-radius: 8px;
    margin-bottom: 15px;
  }
  
  #nft-modal h3 {
    margin: 8px 0 4px;
    font-size: 1.1rem;
    font-weight: 600;
  }
  
  #nft-modal p {
    margin: 4px 0;
    font-size: 0.9rem;
    color: var(--text-light);
  }
  
  .nft-actions {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 10px;
  }
  
  button {
    border: none;
    background: var(--accent);
    color: white;
    padding: 8px 12px;
    border-radius: 8px;
    font-size: 0.85rem;
    cursor: pointer;
    transition: background 0.2s;
  }
  
  button:hover {
    background: #2563eb;
  }
  
  #close-modal {
    position: absolute;
    top: 10px;
    right: 10px;
    background: #ef4444;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  #close-modal:hover {
    background: #dc2626;
  }
  
  #mini-map {
    position: absolute;
    top: 70px;
    right: 10px;
    width: 120px;
    height: 120px;
    background: rgba(0,0,0,0.5);
    border-radius: 8px;
    z-index: 100;
    border: 2px solid white;
  }
  
  /* Sidebar Styles */
  #sidebar {
    position: absolute;
    top: 60px;
    left: 0;
    width: var(--sidebar-width);
    height: calc(100% - 60px);
    background: rgba(0, 0, 0, 0.85);
    color: white;
    z-index: 90;
    transition: transform 0.3s ease;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    box-shadow: 2px 0 10px rgba(0, 0, 0, 0.5);
  }
  
  #sidebar.collapsed {
    transform: translateX(calc(var(--sidebar-collapsed) - var(--sidebar-width)));
  }
  
  #sidebar-toggle {
    position: absolute;
    top: 10px;
    right: -40px;
    width: 40px;
    height: 40px;
    background: rgba(0, 0, 0, 0.85);
    border: none;
    color: white;
    font-size: 1.2rem;
    cursor: pointer;
    border-radius: 0 8px 8px 0;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 95;
  }
  
  #sidebar-content {
    flex: 1;
    padding: 15px;
    overflow-y: auto;
  }
  
  .sidebar-section {
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }
  
  .sidebar-section:last-child {
    border-bottom: none;
  }
  
  .sidebar-section h3 {
    margin: 0 0 12px 0;
    font-size: 1rem;
    color: #3b82f6;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .sidebar-section h3 i {
    font-size: 1.1rem;
  }
  
  .info-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
    padding: 6px 0;
  }
  
  .info-label {
    font-size: 0.85rem;
    color: #cbd5e1;
  }
  
  .info-value {
    font-size: 0.9rem;
    font-weight: 600;
    color: white;
  }
  
  .health-bar {
    width: 100%;
    height: 8px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 4px;
    overflow: hidden;
    margin-top: 4px;
  }
  
  .health-fill {
    height: 100%;
    background: linear-gradient(90deg, #ef4444, #22c55e);
    border-radius: 4px;
    transition: width 0.3s ease;
  }
  
  .bullets-bar {
    width: 100%;
    height: 8px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 4px;
    overflow: hidden;
    margin-top: 4px;
  }
  
  .bullets-fill {
    height: 100%;
    background: linear-gradient(90deg, #f59e0b, #eab308);
    border-radius: 4px;
    transition: width 0.3s ease;
  }
  
  #location-display {
    background: rgba(59, 130, 246, 0.2);
    padding: 10px;
    border-radius: 6px;
    font-size: 0.85rem;
    line-height: 1.4;
    margin-top: 8px;
  }
  
  #players-list {
    max-height: 200px;
    overflow-y: auto;
  }
  
  .player-item {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
    padding: 6px;
    border-radius: 4px;
    background: rgba(255, 255, 255, 0.1);
  }
  
  .player-color {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 10px;
  }
  
  .player-name {
    flex: 1;
    font-size: 0.85rem;
  }
  
  /* Combat UI */
  #crosshair {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 20px;
    height: 20px;
    z-index: 50;
    pointer-events: none;
  }
  
  .crosshair-dot {
    position: absolute;
    width: 4px;
    height: 4px;
    background: #00ff00;
    border-radius: 50%;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }
  
  .crosshair-line {
    position: absolute;
    background: #00ff00;
  }
  
  .crosshair-horizontal {
    width: 12px;
    height: 2px;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }
  
  .crosshair-vertical {
    width: 2px;
    height: 12px;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }
  
  #hit-marker {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 30px;
    height: 30px;
    opacity: 0;
    pointer-events: none;
    z-index: 60;
    transition: opacity 0.1s;
  }
  
  #hit-marker.visible {
    opacity: 1;
  }
  
  /* Bullet Purchase Modal */
  #bullet-modal {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: var(--card-bg);
    border-radius: 16px;
    box-shadow: var(--shadow);
    padding: 20px;
    z-index: 1000;
    max-width: 90%;
    width: 350px;
  }
  
  #bullet-modal h3 {
    margin: 0 0 15px 0;
    text-align: center;
    color: #ef4444;
  }
  
  .bullet-option {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    margin-bottom: 10px;
    background: #f8fafc;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
  }
  
  .bullet-option button {
    background: #10b981;
  }
  
  .bullet-option button:hover {
    background: #059669;
  }
  
  /* Chat Panel */
  #chat-panel {
    position: absolute;
    bottom: 200px;
    left: 10px;
    width: 300px;
    max-height: 200px;
    background: rgba(0,0,0,0.7);
    border-radius: 8px;
    z-index: 100;
    display: flex;
    flex-direction: column;
  }
  
  #chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 8px;
    color: white;
    font-size: 0.8rem;
  }
  
  .chat-message {
    margin-bottom: 5px;
    word-wrap: break-word;
  }
  
  .chat-sender {
    font-weight: bold;
    color: #3b82f6;
  }
  
  #chat-input-container {
    display: flex;
    padding: 8px;
    border-top: 1px solid rgba(255,255,255,0.2);
  }
  
  #chat-input {
    flex: 1;
    padding: 4px 8px;
    border: none;
    border-radius: 4px;
    background: rgba(255,255,255,0.9);
    font-size: 0.8rem;
  }
  
  #chat-send {
    margin-left: 5px;
    padding: 4px 8px;
    background: var(--accent);
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.8rem;
  }
  
  #avatar-selection {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 2000;
  }
  
  #avatar-selection h2 {
    color: white;
    margin-bottom: 30px;
    font-size: 1.8rem;
  }
  
  .avatar-options {
    display: flex;
    gap: 30px;
    flex-wrap: wrap;
    justify-content: center;
  }
  
  .avatar-option {
    width: 200px;
    height: 300px;
    border-radius: 12px;
    overflow: hidden;
    cursor: pointer;
    transition: transform 0.3s, box-shadow 0.3s;
    border: 3px solid transparent;
  }
  
  .avatar-option:hover {
    transform: scale(1.05);
    box-shadow: 0 10px 20px rgba(0,0,0,0.3);
  }
  
  .avatar-option.selected {
    border-color: var(--accent);
    box-shadow: 0 0 20px var(--accent);
  }
  
  #boy-avatar {
    background-image: url('https://raw.githubusercontent.com/diamondrolls/images/main/431BBB65-C6F8-49BC-B882-EA5BBE885462.png');
    background-size: cover;
    background-position: center;
  }
  
  #girl-avatar {
    background-image: url('https://raw.githubusercontent.com/diamondrolls/images/main/3974D02C-0D5B-4F49-8597-5185D48FB2A1.png');
    background-size: cover;
    background-position: center;
  }
  
  #confirm-avatar {
    margin-top: 30px;
    padding: 12px 24px;
    font-size: 1.1rem;
    background: var(--accent);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.2s;
  }
  
  #confirm-avatar:hover {
    background: #2563eb;
  }
  
  @media (max-width: 500px) { 
    header h1 { font-size: 1.2rem; } 
    #instructions {
      font-size: 0.7rem;
      bottom: 5px;
    }
    #mobile-controls {
      bottom: 60px;
    }
    #look-controls {
      bottom: 60px;
      width: 100px;
      height: 100px;
    }
    .mobile-btn {
      width: 45px;
      height: 45px;
      font-size: 1rem;
    }
    #mini-map {
      width: 100px;
      height: 100px;
      top: 60px;
    }
    .avatar-option {
      width: 150px;
      height: 225px;
    }
    #avatar-selection h2 {
      font-size: 1.4rem;
    }
    #sidebar {
      width: 220px;
    }
    #chat-panel {
      width: 250px;
      bottom: 150px;
    }
  }
</style>
</head>
<body>

<header>
  <h1>NFT Universe Explorer - Combat</h1>
  <div id="walletStatus">Not connected</div>
  <button id="connectBtn">Connect Wallet</button>
</header>

<a href='https://diamondrolls.github.io/thepremiumway/'> 
  <div class="homepage">Home</div>
</a>

<div id="canvas-container"></div>

<div id="instructions">
  <div id="desktop-instructions">Click to lock pointer and navigate with WASD keys. Move mouse to look around. Press SPACE to jump. Left-click to shoot. Press T to chat. Explore NFTs in the vertical column and bridge!</div>
  <div id="mobile-instructions" style="display:none;">Use controls to move and look around. Tap gun button to shoot. Explore NFTs in the vertical column and bridge!</div>
</div>

<!-- Crosshair -->
<div id="crosshair">
  <div class="crosshair-dot"></div>
  <div class="crosshair-line crosshair-horizontal"></div>
  <div class="crosshair-line crosshair-vertical"></div>
</div>

<!-- Hit Marker -->
<div id="hit-marker">‚úï</div>

<!-- Sidebar -->
<div id="sidebar">
  <button id="sidebar-toggle">‚óÄ</button>
  <div id="sidebar-content">
    <!-- Combat Stats Section -->
    <div class="sidebar-section">
      <h3>‚öîÔ∏è Combat</h3>
      <div class="info-item">
        <span class="info-label">Health:</span>
        <span class="info-value" id="health-display">50/50</span>
      </div>
      <div class="health-bar">
        <div class="health-fill" id="health-bar" style="width: 100%;"></div>
      </div>
      <div class="info-item" style="margin-top: 12px;">
        <span class="info-label">Bullets:</span>
        <span class="info-value" id="bullets-display">100/500</span>
      </div>
      <div class="bullets-bar">
        <div class="bullets-fill" id="bullets-bar" style="width: 20%;"></div>
      </div>
    </div>
    
    <!-- Location Section -->
    <div class="sidebar-section">
      <h3>üìç Location</h3>
      <div id="location-display">Starting Area</div>
    </div>
    
    <!-- NFTs Section -->
    <div class="sidebar-section">
      <h3>üñºÔ∏è NFTs</h3>
      <div class="info-item">
        <span class="info-label">Loaded:</span>
        <span class="info-value" id="nft-count">0</span>
      </div>
    </div>
    
    <!-- Players Section -->
    <div class="sidebar-section">
      <h3>üë• Players</h3>
      <div class="info-item">
        <span class="info-label">Online:</span>
        <span class="info-value" id="player-count">1</span>
      </div>
      <div id="players-list">
        <div class="player-item">
          <div class="player-color" style="background-color: #3b82f6;"></div>
          <div class="player-name">You</div>
        </div>
      </div>
    </div>
    
    <!-- Stats Section -->
    <div class="sidebar-section">
      <h3>üìä Stats</h3>
      <div class="info-item">
        <span class="info-label">Play Time:</span>
        <span class="info-value" id="play-time">0m</span>
      </div>
      <div class="info-item">
        <span class="info-label">Distance Traveled:</span>
        <span class="info-value" id="distance-traveled">0m</span>
      </div>
      <div class="info-item">
        <span class="info-label">Players Eliminated:</span>
        <span class="info-value" id="eliminations">0</span>
      </div>
    </div>
  </div>
</div>

<!-- Bullet Purchase Modal -->
<div id="bullet-modal">
  <button id="close-bullet-modal" style="position: absolute; top: 10px; right: 10px; background: #ef4444; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">X</button>
  <h3>üî´ Out of Bullets!</h3>
  <p style="text-align: center; margin-bottom: 20px; color: var(--text-light);">Purchase more bullets using crypto:</p>
  
  <div class="bullet-option">
    <div>
      <strong>100 Bullets</strong>
      <div style="font-size: 0.9rem; color: var(--text-light);">0.005 ETH</div>
    </div>
    <button id="buy-100-bullets">Buy</button>
  </div>
  
  <div class="bullet-option">
    <div>
      <strong>500 Bullets</strong>
      <div style="font-size: 0.9rem; color: var(--text-light);">0.025 ETH</div>
    </div>
    <button id="buy-500-bullets">Buy</button>
  </div>
  
  <div style="text-align: center; margin-top: 15px; font-size: 0.8rem; color: var(--text-light);">
    Max capacity: 500 bullets
  </div>
</div>

<!-- Chat Panel -->
<div id="chat-panel">
  <div id="chat-messages"></div>
  <div id="chat-input-container">
    <input type="text" id="chat-input" placeholder="Type a message...">
    <button id="chat-send">Send</button>
  </div>
</div>

<div id="mobile-controls">
  <div class="mobile-btn" id="forward-btn">‚Üë</div>
  <div style="display:flex; gap:10px;">
    <div class="mobile-btn" id="left-btn">‚Üê</div>
    <div class="mobile-btn" id="backward-btn">‚Üì</div>
    <div class="mobile-btn" id="right-btn">‚Üí</div>
  </div>
  <div class="mobile-btn" id="gun-btn">üî´</div>
</div>

<div id="look-controls"></div>

<div id="mini-map"></div>

<!-- NFT Modal -->
<div id="nft-modal">
  <button id="close-modal">X</button>
  <img id="modal-image" src="" alt="NFT" />
  <div class="nft-info">
    <h3 id="modal-title"></h3>
    <p id="modal-description"></p>
    <p><strong>Price:</strong> <span id="modal-price"></span> ETH</p>
    <div class="nft-actions" id="modal-actions"></div>
  </div>
</div>

<div id="avatar-selection">
  <h2>Choose Your Explorer</h2>
  <div class="avatar-options">
    <div class="avatar-option" id="boy-avatar" data-avatar="boy"></div>
    <div class="avatar-option" id="girl-avatar" data-avatar="girl"></div>
  </div>
  <div style="margin-top: 20px;">
    <input type="text" id="player-name" placeholder="Enter your display name" maxlength="15" style="padding: 8px; border-radius: 4px; border: 1px solid #ccc; width: 200px;">
  </div>
  <button id="confirm-avatar">Start Exploring</button>
</div>

<script>
/* ==============================
   CONFIGURATION
============================== */
const supabaseUrl = "https://fjtzodjudyctqacunlqp.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZqdHpvZGp1ZHljdHFhY3VubHFwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwNjA2OTQsImV4cCI6MjA3MzYzNjY5NH0.qR9RBsecfGUfKnbWgscmxloM-oEClJs_bo5YWoxFoE4";
const client = supabase.createClient(supabaseUrl, supabaseKey);

const NFT_CONTRACT_ADDRESS = "0x3ed4474a942d885d5651c8c56b238f3f4f524a5c";
const NFT_ABI = [
  { "constant":true,"inputs":[{"name":"tokenId","type":"uint256"}],"name":"ownerOf","outputs":[{"name":"","type":"address"}],"type":"function" },
  { "constant":false,"inputs":[{"name":"from","type":"address"},{"name":"to","type":"address"},{"name":"tokenId","type":"uint256"}],"name":"safeTransferFrom","outputs":[],"type":"function" }
];
const RECEIVER_ADDRESS = "0xaE0C180e071eE288B2F2f6ff6edaeF014678fFB7";

let web3, account, nftContract;

// Redirect to login page if not logged in
client.auth.getSession().then(({ data }) => {
  if (!data.session) {
    window.location.href = 'https://diamondrolls.github.io/play/';
  }
});

/* ==============================
   COMBAT SYSTEM
============================== */
class CombatSystem {
  constructor() {
    this.bullets = 100;
    this.maxBullets = 500;
    this.health = 50;
    this.maxHealth = 50;
    this.bulletPrice100 = 0.005; // ETH
    this.bulletPrice500 = 0.025; // ETH
    this.eliminations = 0;
    
    this.init();
  }

  init() {
    this.setupCombatUI();
    this.setupEventListeners();
    this.updateCombatUI();
  }

  setupCombatUI() {
    // Create crosshair
    const crosshair = document.createElement('div');
    crosshair.id = 'crosshair';
    crosshair.innerHTML = `
      <div class="crosshair-dot"></div>
      <div class="crosshair-line crosshair-horizontal"></div>
      <div class="crosshair-line crosshair-vertical"></div>
    `;
    document.body.appendChild(crosshair);

    // Create hit marker
    const hitMarker = document.createElement('div');
    hitMarker.id = 'hit-marker';
    hitMarker.innerHTML = '‚úï';
    hitMarker.style.color = '#ef4444';
    hitMarker.style.fontSize = '30px';
    hitMarker.style.fontWeight = 'bold';
    hitMarker.style.textAlign = 'center';
    document.body.appendChild(hitMarker);

    // Replace jump button with gun button on mobile
    if (isMobile) {
      const jumpBtn = document.getElementById('jump-btn');
      if (jumpBtn) {
        jumpBtn.id = 'gun-btn';
        jumpBtn.innerHTML = 'üî´';
        jumpBtn.style.background = 'rgba(220, 38, 38, 0.7)';
      }
    }
  }

  setupEventListeners() {
    // Desktop shooting with mouse click
    if (!isMobile) {
      document.addEventListener('click', (e) => {
        if (controls && controls.isLocked) {
          this.shoot();
        }
      });
    }

    // Mobile shooting with gun button
    if (isMobile) {
      const gunBtn = document.getElementById('gun-btn');
      if (gunBtn) {
        gunBtn.addEventListener('touchstart', (e) => {
          e.preventDefault();
          this.shoot();
        });
      }
    }

    // Bullet purchase modal
    document.getElementById('close-bullet-modal').addEventListener('click', () => {
      document.getElementById('bullet-modal').style.display = 'none';
    });

    // Crypto bullet purchases
    document.getElementById('buy-100-bullets').addEventListener('click', () => {
      this.buyBullets(100, this.bulletPrice100);
    });

    document.getElementById('buy-500-bullets').addEventListener('click', () => {
      this.buyBullets(500, this.bulletPrice500);
    });
  }

  shoot() {
    if (this.bullets <= 0) {
      this.showBulletPurchaseModal();
      return;
    }

    // Deduct bullet
    this.bullets--;
    this.updateCombatUI();

    // Create shooting effect
    this.showHitMarker();

    // Raycast to detect hits
    if (window.raycaster && window.camera && window.scene) {
      raycaster.setFromCamera(new THREE.Vector2(0, 0), camera);
      
      // Check for player hits
      if (multiplayer && multiplayer.otherPlayers.size > 0) {
        const players = Array.from(multiplayer.otherPlayers.values());
        const playerMeshes = players.map(player => player.group.children[1]); // Avatar mesh
        
        const intersects = raycaster.intersectObjects(playerMeshes, true);
        
        if (intersects.length > 0) {
          const hitPlayer = players.find(player => 
            player.group.children[1] === intersects[0].object.parent
          );
          
          if (hitPlayer) {
            this.handlePlayerHit(hitPlayer);
          }
        }
      }

      // Check for NFT hits
      const nftIntersects = raycaster.intersectObjects(nftObjects, true);
      if (nftIntersects.length > 0) {
        const nft = nftIntersects[0].object;
        this.handleNFTHit(nft);
      }
    }

    // Visual/audio feedback
    this.createMuzzleFlash();
  }

  showHitMarker() {
    const hitMarker = document.getElementById('hit-marker');
    hitMarker.classList.add('visible');
    setTimeout(() => {
      hitMarker.classList.remove('visible');
    }, 100);
  }

  createMuzzleFlash() {
    // Create a simple muzzle flash effect
    if (window.scene && window.camera) {
      const flashGeometry = new THREE.SphereGeometry(0.5, 8, 8);
      const flashMaterial = new THREE.MeshBasicMaterial({ 
        color: 0xffff00, 
        transparent: true, 
        opacity: 0.8 
      });
      const flash = new THREE.Mesh(flashGeometry, flashMaterial);
      
      // Position flash in front of camera
      const direction = new THREE.Vector3();
      camera.getWorldDirection(direction);
      flash.position.copy(camera.position).add(direction.multiplyScalar(5));
      
      scene.add(flash);
      
      // Remove flash after short time
      setTimeout(() => {
        scene.remove(flash);
      }, 50);
    }
  }

  handlePlayerHit(hitPlayer) {
    // In a real implementation, this would send damage data to the other player
    console.log(`Hit player: ${hitPlayer.name}`);
    
    // Award bullets for elimination (simulated)
    this.bullets = Math.min(this.maxBullets, this.bullets + 300);
    this.eliminations++;
    
    // Update UI
    this.updateCombatUI();
    document.getElementById('eliminations').textContent = this.eliminations;
    
    // Send chat message
    if (multiplayer) {
      multiplayer.addChatMessage('System', `You eliminated ${hitPlayer.name}! +300 bullets`, false);
    }
  }

  handleNFTHit(nft) {
    const nftData = nft.userData.nftData;
    console.log(`Hit NFT: ${nftData.name}`);
    
    // Award bullets for NFT hit
    this.bullets = Math.min(this.maxBullets, this.bullets + 50);
    this.updateCombatUI();
    
    // Send chat message
    if (multiplayer) {
      multiplayer.addChatMessage('System', `You hit an NFT! +50 bullets`, false);
    }
  }

  takeDamage(amount) {
    this.health = Math.max(0, this.health - amount);
    this.updateCombatUI();
    
    if (this.health <= 0) {
      this.respawn();
    }
  }

  respawn() {
    // Reset player stats
    this.health = this.maxHealth;
    this.bullets = 100;
    this.updateCombatUI();
    
    // Reset player position
    if (window.playerAvatar) {
      playerAvatar.position.set(0, 3, 0);
    }
    
    // Send chat message
    if (multiplayer) {
      multiplayer.addChatMessage('System', 'You have been eliminated! Respawning...', false);
    }
  }

  showBulletPurchaseModal() {
    document.getElementById('bullet-modal').style.display = 'block';
  }

  async buyBullets(amount, price) {
    if (!account) {
      alert('Please connect your wallet first!');
      return;
    }

    try {
      const totalEth = web3.utils.toWei(price.toString(), 'ether');
      
      // Send payment
      await web3.eth.sendTransaction({ 
        from: account, 
        to: RECEIVER_ADDRESS, 
        value: totalEth 
      });

      // Add bullets
      this.bullets = Math.min(this.maxBullets, this.bullets + amount);
      this.updateCombatUI();
      
      // Close modal
      document.getElementById('bullet-modal').style.display = 'none';
      
      alert(`‚úÖ Successfully purchased ${amount} bullets!`);
      
    } catch(err) {
      console.error('Bullet purchase failed:', err);
      alert('Purchase failed: ' + err.message);
    }
  }

  updateCombatUI() {
    // Update health display
    document.getElementById('health-display').textContent = `${this.health}/${this.maxHealth}`;
    document.getElementById('health-bar').style.width = `${(this.health / this.maxHealth) * 100}%`;
    
    // Update bullets display
    document.getElementById('bullets-display').textContent = `${this.bullets}/${this.maxBullets}`;
    document.getElementById('bullets-bar').style.width = `${(this.bullets / this.maxBullets) * 100}%`;
    
    // Update eliminations
    document.getElementById('eliminations').textContent = this.eliminations;
  }
}

// Global combat system instance
let combatSystem;

/* ==============================
   SIDEBAR FUNCTIONALITY
============================== */
function initSidebar() {
  const sidebar = document.getElementById('sidebar');
  const toggleButton = document.getElementById('sidebar-toggle');
  
  // Toggle sidebar collapse/expand
  toggleButton.addEventListener('click', () => {
    sidebar.classList.toggle('collapsed');
    toggleButton.textContent = sidebar.classList.contains('collapsed') ? '‚ñ∂' : '‚óÄ';
  });
  
  // Auto-collapse on mobile
  if (window.innerWidth <= 500) {
    sidebar.classList.add('collapsed');
    toggleButton.textContent = '‚ñ∂';
  }
  
  // Initialize stats tracking
  initStatsTracking();
}

function initStatsTracking() {
  let playTime = 0;
  let distanceTraveled = 0;
  let lastPosition = null;
  
  // Update play time every minute
  setInterval(() => {
    playTime++;
    document.getElementById('play-time').textContent = `${playTime}m`;
  }, 60000);
  
  // Track distance traveled
  setInterval(() => {
    if (window.playerAvatar && lastPosition) {
      const currentPosition = window.playerAvatar.position.clone();
      const distance = currentPosition.distanceTo(lastPosition);
      distanceTraveled += distance;
      document.getElementById('distance-traveled').textContent = `${Math.round(distanceTraveled)}m`;
    }
    if (window.playerAvatar) {
      lastPosition = window.playerAvatar.position.clone();
    }
  }, 1000);
}

/* ==============================
   AVATAR SELECTION
============================== */
let selectedAvatar = null;
const avatarOptions = document.querySelectorAll('.avatar-option');
const confirmButton = document.getElementById('confirm-avatar');
const avatarSelection = document.getElementById('avatar-selection');

avatarOptions.forEach(option => {
  option.addEventListener('click', () => {
    // Remove selected class from all options
    avatarOptions.forEach(opt => opt.classList.remove('selected'));
    // Add selected class to clicked option
    option.classList.add('selected');
    selectedAvatar = option.getAttribute('data-avatar');
  });
});

confirmButton.addEventListener('click', () => {
  if (selectedAvatar) {
    // Initialize combat system
    combatSystem = new CombatSystem();
    
    // Initialize sidebar
    initSidebar();
    
    // Initialize multiplayer
    multiplayer = new WebRTCMultiplayer();
    
    // Set player name from input
    const nameInput = document.getElementById('player-name');
    if (nameInput && nameInput.value.trim()) {
      multiplayer.playerName = nameInput.value.trim();
    }
    
    // Generate random color for player
    multiplayer.playerColor = Math.random() * 0xFFFFFF;
    
    avatarSelection.style.display = 'none';
    init3DScene();
    loadNFTs();
    
    // Start position updates
    setInterval(() => {
      if (multiplayer) {
        multiplayer.sendPositionUpdate();
      }
    }, 100);
    
  } else {
    alert('Please select an avatar to continue');
  }
});

/* ==============================
   MOBILE DETECTION & CONTROLS
============================== */
const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false;
let lookTouchId = null;
let lookStartX = 0, lookStartY = 0;
let lookX = 0, lookY = 0;
let velocity = new THREE.Vector3();
let canJump = true;

if (isMobile) {
  document.getElementById('desktop-instructions').style.display = 'none';
  document.getElementById('mobile-instructions').style.display = 'block';
  
  // Set up mobile movement controls
  document.getElementById('forward-btn').addEventListener('touchstart', (e) => {
    e.preventDefault();
    moveForward = true;
  });
  document.getElementById('forward-btn').addEventListener('touchend', (e) => {
    e.preventDefault();
    moveForward = false;
  });
  
  document.getElementById('backward-btn').addEventListener('touchstart', (e) => {
    e.preventDefault();
    moveBackward = true;
  });
  document.getElementById('backward-btn').addEventListener('touchend', (e) => {
    e.preventDefault();
    moveBackward = false;
  });
  
  document.getElementById('left-btn').addEventListener('touchstart', (e) => {
    e.preventDefault();
    moveLeft = true;
  });
  document.getElementById('left-btn').addEventListener('touchend', (e) => {
    e.preventDefault();
    moveLeft = false;
  });
  
  document.getElementById('right-btn').addEventListener('touchstart', (e) => {
    e.preventDefault();
    moveRight = true;
  });
  document.getElementById('right-btn').addEventListener('touchend', (e) => {
    e.preventDefault();
    moveRight = false;
  });
  
  // Set up look controls
  const lookControls = document.getElementById('look-controls');
  lookControls.addEventListener('touchstart', (e) => {
    e.preventDefault();
    if (lookTouchId === null) {
      const touch = e.touches[0];
      lookTouchId = touch.identifier;
      lookStartX = touch.clientX;
      lookStartY = touch.clientY;
    }
  });
  
  lookControls.addEventListener('touchmove', (e) => {
    e.preventDefault();
    for (let i = 0; i < e.changedTouches.length; i++) {
      const touch = e.changedTouches[i];
      if (touch.identifier === lookTouchId) {
        const deltaX = touch.clientX - lookStartX;
        const deltaY = touch.clientY - lookStartY;
        
        lookX = deltaX * 0.5;
        lookY = deltaY * 0.5;
        
        lookStartX = touch.clientX;
        lookStartY = touch.clientY;
        break;
      }
    }
  });
  
  lookControls.addEventListener('touchend', (e) => {
    e.preventDefault();
    for (let i = 0; i < e.changedTouches.length; i++) {
      const touch = e.changedTouches[i];
      if (touch.identifier === lookTouchId) {
        lookTouchId = null;
        lookX = 0;
        lookY = 0;
        break;
      }
    }
  });
}

/* ==============================
   3D SCENE SETUP - THIRD PERSON
============================== */
let scene, camera, renderer, controls;
let nftObjects = [], environmentObjects = [], buildingObjects = [];
let raycaster, mouse;
let currentIntersected = null;
let miniMapScene, miniMapCamera, miniMapRenderer;
let playerAvatar;
let worldSize = 800;
let worldBoundary = worldSize / 2 - 50;
let clock = new THREE.Clock();
let prevTime = 0;

// Third-person camera variables
let cameraDistance = 25;
let cameraHeight = 10;
let cameraAngle = 0;
let targetCameraAngle = 0;

// Floating board variables
let hoverBoard;
let hoverHeight = 3; // Height above ground
let hoverBobSpeed = 2; // Bobbing speed
let hoverBobAmount = 0.3; // Bobbing amount
let hoverTime = 0;

// Collision detection variables
let collisionObjects = [];
let roofObjects = [];
let playerCollider = new THREE.Box3();
let playerSize = new THREE.Vector3(10, 2, 10); // Same size as NFT displays
let playerOnRoof = false;
let currentRoof = null;

// NFT platform variables
let nftPlatforms = [];
let bridgeSegments = [];

function init3DScene() {
  // Create scene
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x000033);
  scene.fog = new THREE.Fog(0x000033, 100, 2000);
  
  // Create camera - Third person perspective
  camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 5000);
  
  // Create renderer
  renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.shadowMap.enabled = true;
  renderer.shadowMap.type = THREE.PCFSoftShadowMap;
  document.getElementById('canvas-container').appendChild(renderer.domElement);
  
  // Add lighting
  const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
  scene.add(ambientLight);
  
  const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
  directionalLight.position.set(100, 200, 100);
  directionalLight.castShadow = true;
  directionalLight.shadow.mapSize.width = 2048;
  directionalLight.shadow.mapSize.height = 2048;
  directionalLight.shadow.camera.near = 0.5;
  directionalLight.shadow.camera.far = 2000;
  directionalLight.shadow.camera.left = -500;
  directionalLight.shadow.camera.right = 500;
  directionalLight.shadow.camera.top = 500;
  directionalLight.shadow.camera.bottom = -500;
  scene.add(directionalLight);
  
  // Create the world
  createWorld();
  
  // Create player avatar with floating board
  createPlayerAvatar();
  
  // Set initial camera position for third-person view
  updateThirdPersonCamera();
  
  // Set up controls
  if (!isMobile) {
    controls = new THREE.PointerLockControls(camera, document.body);
    
    document.addEventListener('click', function() {
      if (!controls.isLocked) {
        controls.lock();
      }
    });
    
    controls.addEventListener('lock', function() {
      document.getElementById('instructions').style.display = 'none';
    });
    
    controls.addEventListener('unlock', function() {
      document.getElementById('instructions').style.display = 'block';
    });
    
    // Keyboard controls for desktop
    const onKeyDown = function (event) {
      switch (event.code) {
        case 'ArrowUp':
        case 'KeyW':
          moveForward = true;
          break;
        case 'ArrowLeft':
        case 'KeyA':
          moveLeft = true;
          break;
        case 'ArrowDown':
        case 'KeyS':
          moveBackward = true;
          break;
        case 'ArrowRight':
        case 'KeyD':
          moveRight = true;
          break;
        case 'Space':
          if (canJump) {
            velocity.y += 350;
            canJump = false;
          }
          break;
      }
    };
    
    const onKeyUp = function (event) {
      switch (event.code) {
        case 'ArrowUp':
        case 'KeyW':
          moveForward = false;
          break;
        case 'ArrowLeft':
        case 'KeyA':
          moveLeft = false;
          break;
        case 'ArrowDown':
        case 'KeyS':
          moveBackward = false;
          break;
        case 'ArrowRight':
        case 'KeyD':
          moveRight = false;
          break;
      }
    };
    
    document.addEventListener('keydown', onKeyDown);
    document.addEventListener('keyup', onKeyUp);
    
    // Mouse movement for third-person camera
    document.addEventListener('mousemove', (event) => {
      if (controls && controls.isLocked) {
        targetCameraAngle -= event.movementX * 0.002;
      }
    });
  }
  
  // Set up raycaster for object interaction
  raycaster = new THREE.Raycaster();
  mouse = new THREE.Vector2();
  
  // Handle window resize
  window.addEventListener('resize', onWindowResize);
  
  // Initialize mini-map
  initMiniMap();
  
  // Start animation
  animate();
}

// ... (REST OF THE 3D SCENE CODE WOULD GO HERE - SAME AS BEFORE)
// Including createWorld, createMoonBridge, createCity, createPlayerAvatar, etc.
// This would be several hundred lines of existing code

/* ==============================
   WEBRTC MULTIPLAYER (SIMPLIFIED)
============================== */
class WebRTCMultiplayer {
  constructor() {
    this.otherPlayers = new Map();
    this.playerName = 'Explorer';
    this.playerColor = 0x3B82F6;
    this.init();
  }

  init() {
    this.setupChat();
    // Simulate other players for demo
    this.simulateOtherPlayers();
  }

  setupChat() {
    const chatInput = document.getElementById('chat-input');
    const chatSend = document.getElementById('chat-send');
    
    if (chatSend) {
      chatSend.addEventListener('click', () => this.sendChatMessage());
    }
    
    if (chatInput) {
      chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          this.sendChatMessage();
        }
      });
    }
  }

  sendChatMessage() {
    const chatInput = document.getElementById('chat-input');
    const message = chatInput.value.trim();
    
    if (message) {
      this.addChatMessage(this.playerName, message, true);
      chatInput.value = '';
    }
  }

  addChatMessage(sender, message, isOwn) {
    const chatMessages = document.getElementById('chat-messages');
    if (chatMessages) {
      const messageElement = document.createElement('div');
      messageElement.className = 'chat-message';
      
      if (isOwn) {
        messageElement.innerHTML = `<span class="chat-sender">You:</span> ${message}`;
      } else {
        messageElement.innerHTML = `<span class="chat-sender">${sender}:</span> ${message}`;
      }
      
      chatMessages.appendChild(messageElement);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
  }

  simulateOtherPlayers() {
    // Simulate a few players for demo
    setTimeout(() => {
      this.addChatMessage('System', 'Player "CryptoHunter" joined the game', false);
    }, 3000);
    
    setTimeout(() => {
      this.addChatMessage('System', 'Player "NFTCollector" joined the game', false);
    }, 6000);
    
    setTimeout(() => {
      this.addChatMessage('CryptoHunter', 'Anyone found rare NFTs?', false);
    }, 9000);
  }

  sendPositionUpdate() {
    // Position updates would be sent via WebRTC in real implementation
  }
}

// Global multiplayer instance
let multiplayer;

/* ==============================
   NFT FUNCTIONALITY
============================== */
// ... (EXISTING NFT CODE WOULD GO HERE)
// Including loadNFTs, createNFTPlane, openNFTModal, etc.

/* ==============================
   WALLET CONNECTION
============================== */
async function connectWallet() {
  try {
    if (window.ethereum) {
      web3 = new Web3(window.ethereum);
      const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
      account = accounts[0];
    } else {
      const provider = new WalletConnectProvider.default({
        rpc: { 1: "https://mainnet.infura.io/v3/d71dd33696d449e488a88bdc02a6093c" },
      });
      await provider.enable();
      web3 = new Web3(provider);
      const accounts = await web3.eth.getAccounts();
      account = accounts[0];
    }

    document.getElementById("walletStatus").innerText =
      `‚úÖ Connected: ${account.slice(0, 6)}...${account.slice(-4)}`;

    nftContract = new web3.eth.Contract(NFT_ABI, NFT_CONTRACT_ADDRESS);
    
    // Reload NFTs to show wallet-specific options
    if (avatarSelection.style.display === 'none') {
      loadNFTs();
    }

  } catch (err) {
    console.error(err);
    alert("Failed to connect wallet.");
  }
}

document.getElementById("connectBtn").addEventListener("click", connectWallet);

// Clean up when leaving
window.addEventListener('beforeunload', () => {
  if (multiplayer) {
    multiplayer.disconnect();
  }
});
</script>

</body>
</html>
